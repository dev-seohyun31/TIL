# 실제 개념

## 버스 시스템이란
버스 시스템(Bus System)은 MCU 내부에서 CPU, 메모리, 주변장치들이 주소 기반으로 데이터를 교환하기 위한 내부 통신 인프라입니다. 

일반적인 wire(선)가 단순히 전압 신호를 전달하는 물리적 연결이라면,
버스는 다음과 같은 요소들이 결합된 구조입니다.
1. 여러 개의 물리 신호선의 묶음: 주소 선 + 데이터 선 + 제어 선
1. 해당 신호선이 어떻게 동작해야 하는지 정의한 통신 프로토콜
1. 여러 장치를 연결하고 트래픽을 관리한는 중앙 인터커넥트 로직

즉, 버스는 단순 배선이 아니라, 하드웨어 규칙과 제어 로직이 포함된 시스템 통신 구조입니다. 

### wire vs bus
MCU 핀과 LED가 wire로 연결된 경우, "전압이 HIGH면 LED가 켜진다"는 물리적인 전기 신호를 의미합니다. 

반면 CPU와 GPIO 레지스터가 버스로 연결된 경우, "이 주소를 가진 장치에게 이 데이터를 이 방식(읽기/쓰기, 타이밍 규칙)에 따라 전달한다"는 논리적인 통신 의미를 가지게 됩니다. 

## Bus Interconnect (= Bus Fabric, Bus Matrix, Arbiter)
버스 시스템 중심에는 일반적으로 Bus Interconnect(또는 Bus Matrix, Arbiter)라 불리는 하드웨어 블록이 존재하여 버스가 선 이상의 역할을 수행하도록 합니다.

이 블록은 다음 역할을 수행합니다. 
### 1. 주소 디코딩
CPU가 특정 주소(예: `0xF003A000`)를 접근하면 이 주소가 어떤 장치(예: GPIO, RAM, UART 등)에 해당하는지 판단하여 해당장치로 트랜젝션을 전달합니다. 

### 2. 중재
CPU, DMA, Debug Logic 등 여러 Master가 하나의 자원에 동시에 접근할 경우, 우선순위 기반/Round-robin/Fixed priority 같은 정책으로 누가 먼저 버스를 사용할 지 결정합니다. 

### 3. 데이터 경로 스위칭
여러 Master와 여러 Slave 사이의 연결 경로를 설정하여, 동시에 여러 데이터 흐름이 발생할 수 있도록 관리합니다.


## 구조
현대 MCU는 단일 버스 구조가 아니라,
중앙 Interconnect(Fabric)를 중심으로 여러 버스 계층이 연결된 계층형 구조를 사용합니다. 
각 버스 계층은 연결 대상과 성능 요구에 따라 서로 다른 프로토콜을 사용하며,
필요한 경우 버스 간 프로토콜 변환을 위해 Bridge 블록이 삽입됩니다.

```
            CPU
            DMA
             |
     ------------------------
       Interconnect (Fabric)
     ------------------------
      |        |        |
   AXI Port  AHB Port  Bridge
                        |
                        APB
                   GPIO UART ADC
```
### 주요 프로토콜 계층
#### 1. AXI (AMBA eXtensible Interface)
AXI는 고급 MCU에서 사용되는 최상위 고속 메인 인터커넥트 프로토콜입니다. 

기존 AHB구조는 단일 트랜젝션 중심 구조로 병렬 처리에 한계가 있었고, 멀티코어와 대규모 DMA 환경에서 대역폭이 부족한 한계가 있었습니다. 
이를 해결하기 위해 AXI가 등장했습니다. 

AXI는 주로 다음 기능들을 제공합니다.
* 주소/데이터/응답 채널 분리
* 다중 트랜잭션 동시 처리
* ID 기반 응답 매칭
* 고성능 Burst 전송 지원
    * Burst란, 대역폭 최적화를 목적으로 하나의 주소 요청에 여러 데이터 워드를 한번에 전송하는 방식입니다. (예: 32bit 데이터를 8beat로 8번 연속 전송)

이런 기능들로 다음 고속 데이터 경로에 활용됩니다. 
* CPU ↔ SRAM / Cache
* CPU ↔ Flash Controller
* DMA ↔ Memory
* Hardware Accelerator


#### 2. AHB (AMBA High-performance Bus)
AHB는 AXI보다 구조가 단순한 중간급 성능 시스템 버스입니다. 
* 파이프라인 구조 지원
* Burst 전송 가능
* 중앙 중재 방식 사용 

MCU 내부의 시스템 리소스와 메모리 연결에 널리 사용됩니다. 

AXI와 AHB는 같은 AMBA 계열 프로토콜로 구조가 유사하기 때문에,
일반적으로 직접 연결이 가능하거나 단순 인터페이스 변환만으로 연동되며
APB처럼 반드시 별도의 Bridge가 필요한 구조는 아닙니다.

#### 3. Bridge
Bridge는 서로 다른 버스 프로토콜 또는 속도 도메인을 연결하기 위한
하드웨어 변환 블록입니다.
현대 MCU 구조에서 가장 대표적인 Bridge는* 
고속 버스(AXI/AHB)와 저속 Peripheral 버스(APB)를 연결하는 Bridge입니다.

Bridge의 주요 역할은 다음과 같습니다.
* **프로토콜 변환**: AXI/AHB 트랜잭션 → APB FSM 기반 전송
* **속도 및 타이밍 완충**: 고속 CPU 클록 도메인 ↔ 저속 Peripheral 클록 도메인
* **트랜잭션 직렬화**: Burst / 파이프라인 전송 → 단일 레지스터 접근

Bridge는 Peripheral 장치 쪽에 붙는 것이 아니라,
Interconnect와 APB 버스 사이의 경계에 위치하여
고속 시스템 영역과 저속 주변장치 영역을 분리하는 역할을 수행합니다.

#### 4. APB (AMBA Peripheral Bus)
APB는 주변장치 전용 저속 버스입니다. 
레지스터 접근을 안정적이고 저전력으로 수행하려는 목표를 가지고 있습니다. 
* 단순 FSM 기반 동작
    * FSM이란, 한 번에 하나의 접근만 하는 단발 접근으로 주소 하나당 데이터 하나씩만 보냅니다. 주로 레지스터 접근에 적합합니다.
* Burst 없음
* 파이프라인 없음
* 면적 작음, 전력 소모 적음

위의 특징으로 아래와 같은 장치에 사용됩니다. 
* GPIO
* UART
* Timer
* ADC
* SPI


